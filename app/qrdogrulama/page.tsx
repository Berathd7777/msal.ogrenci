"use client"

import { useState, useEffect, useRef } from "react"
import { ArrowLeft, Camera, CheckCircle } from "lucide-react"
import { Button } from "@/components/ui/button"
import Link from "next/link"

export default function QRDogrulamaPage() {
  const [isScanning, setIsScanning] = useState(false)
    const [isApproved, setIsApproved] = useState(false)
      const [error, setError] = useState<string | null>(null)
        const videoRef = useRef<HTMLVideoElement>(null)
          const streamRef = useRef<MediaStream | null>(null)
            const scannerRef = useRef<any>(null)

              useEffect(() => {
                  return () => {
                        // Cleanup
                              if (streamRef.current) {
                                      streamRef.current.getTracks().forEach((track) => track.stop())
                                            }
                                                  if (scannerRef.current) {
                                                          scannerRef.current.destroy()
                                                                }
                                                                    }
                                                                      }, [])

                                                                        const startScanning = async () => {
                                                                            try {
                                                                                  setError(null)
                                                                                        setIsScanning(true)

                                                                                              // Dinamik import - bu build sorununu Ã§Ã¶zer
                                                                                                    const QrScanner = (await import('qr-scanner')).default

                                                                                                          if (!videoRef.current) {
                                                                                                                  throw new Error("Video element bulunamadÄ±")
                                                                                                                        }

                                                                                                                              // QR Scanner baÅŸlat
                                                                                                                                    scannerRef.current = new QrScanner(
                                                                                                                                            videoRef.current,
                                                                                                                                                    (result) => {
                                                                                                                                                              console.log("QR kod bulundu:", result.data)
                                                                                                                                                                        checkQRContent(result.data)
                                                                                                                                                                                },
                                                                                                                                                                                        {
                                                                                                                                                                                                  onDecodeError: (error) => {
                                                                                                                                                                                                              // SÃ¼rekli decode hatalarÄ±nÄ± gÃ¶rmezden gel
                                                                                                                                                                                                                          console.debug("QR decode error:", error)
                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                              preferredCamera: 'environment', // Arka kamera
                                                                                                                                                                                                                                                        highlightScanRegion: true,
                                                                                                                                                                                                                                                                  highlightCodeOutline: true,
                                                                                                                                                                                                                                                                            maxScansPerSecond: 5
                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                          )

                                                                                                                                                                                                                                                                                                // Kamera baÅŸlat
                                                                                                                                                                                                                                                                                                      await scannerRef.current.start()

                                                                                                                                                                                                                                                                                                          } catch (err: any) {
                                                                                                                                                                                                                                                                                                                console.error("Camera error:", err)
                                                                                                                                                                                                                                                                                                                      setError("Kamera eriÅŸimi reddedildi: " + (err.message || "Bilinmeyen hata"))
                                                                                                                                                                                                                                                                                                                            setIsScanning(false)
                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                    const stopScanning = () => {
                                                                                                                                                                                                                                                                                                                                        setIsScanning(false)
                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                if (scannerRef.current) {
                                                                                                                                                                                                                                                                                                                                                      scannerRef.current.stop()
                                                                                                                                                                                                                                                                                                                                                            scannerRef.current.destroy()
                                                                                                                                                                                                                                                                                                                                                                  scannerRef.current = null
                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                          const checkQRContent = (content: string) => {
                                                                                                                                                                                                                                                                                                                                                                              console.log("QR iÃ§eriÄŸi kontrol ediliyor:", content)

                                                                                                                                                                                                                                                                                                                                                                                  if (content.includes("ð•„ð’ðŸ—ð’â°ð“§")) {
                                                                                                                                                                                                                                                                                                                                                                                        console.log("QR kod onaylandÄ±!")
                                                                                                                                                                                                                                                                                                                                                                                              setIsApproved(true)
                                                                                                                                                                                                                                                                                                                                                                                                    stopScanning()

                                                                                                                                                                                                                                                                                                                                                                                                          // 2 saniye sonra APK indirme sayfasÄ±na yÃ¶nlendir
                                                                                                                                                                                                                                                                                                                                                                                                                setTimeout(() => {
                                                                                                                                                                                                                                                                                                                                                                                                                        window.open("https://github.com/Berathd7777/msal.ogrenci/releases/download/4.3/msal4.3-9d.apk", "_blank")
                                                                                                                                                                                                                                                                                                                                                                                                                                window.location.href = "/"
                                                                                                                                                                                                                                                                                                                                                                                                                                      }, 2000)
                                                                                                                                                                                                                                                                                                                                                                                                                                          } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                setError("GeÃ§ersiz QR kod. LÃ¼tfen yetkili QR kodunu okutunuz.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                      setTimeout(() => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                              setError(null)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // Taramaya devam et - qr-scanner otomatik olarak devam eder
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }, 2000)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div className="min-h-screen bg-background flex flex-col">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <header className="border-b p-4">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div className="flex items-center gap-4">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <Link href="/">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <Button variant="ghost" size="sm">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <ArrowLeft className="h-4 w-4 mr-2" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Geri
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </Button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </Link>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <h1 className="text-lg font-semibold">QR DoÄŸrulama</h1>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </header>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <main className="flex-1 flex flex-col items-center justify-center p-4">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {!isScanning && !isApproved && (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div className="text-center space-y-6 max-w-md">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div className="space-y-2">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <p className="text-sm text-muted-foreground">Yetkiliden QR kodu okutunuz</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div className="w-64 h-64 border-2 border-dashed border-muted-foreground/30 rounded-lg flex items-center justify-center mx-auto">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <Camera className="h-16 w-16 text-muted-foreground/50" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <Button onClick={startScanning} className="w-full">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <Camera className="h-4 w-4 mr-2" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        QR Kod Okutmaya BaÅŸla
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </Button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      )}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              {isScanning && (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div className="text-center space-y-4 max-w-md">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <p className="text-sm text-muted-foreground">QR kodu kamera gÃ¶rÃ¼ÅŸ alanÄ±na getirin</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div className="relative">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <video 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ref={videoRef} 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              className="w-64 h-64 object-cover rounded-lg border" 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              playsInline 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              muted 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              autoPlay
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          {/* QR Scanner kendi highlight'Ä±nÄ± ekler, bu yÃ¼zden manuel overlay kaldÄ±rÄ±ldÄ± */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <Button onClick={stopScanning} variant="outline">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                TaramayÄ± Durdur
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </Button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              )}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      {isApproved && (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div className="text-center space-y-4 max-w-md">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div className="flex flex-col items-center space-y-4">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <CheckCircle className="h-16 w-16 text-green-500" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div className="space-y-2">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <h2 className="text-2xl font-bold text-green-600">OnaylandÄ±</h2>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <p className="text-sm text-muted-foreground">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          QR kod baÅŸarÄ±yla doÄŸrulandÄ±. APK indirme sayfasÄ±na yÃ¶nlendiriliyorsunuz...
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      )}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              {error && (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div className="text-center space-y-4 max-w-md">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="rounded-md bg-destructive/15 p-4">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <p className="text-destructive text-sm">{error}</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <Button onClick={() => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        setError(null)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (!isScanning) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      startScanning()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }} variant="outline">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              Tekrar Dene
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </Button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </main>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
